import { fontWeightReg, fontStyles } from '../transformFontWeights.js';
import { resolveReference } from './resolveReference.js';

function recurse(slice, copy, alwaysAddFontStyle = false) {
    for (const key in slice) {
        const token = slice[key];
        if (typeof token !== 'object' || token === null) {
            continue;
        }
        const { type, value } = token;
        if (type === 'typography') {
            if (typeof value !== 'object' || value.fontWeight === undefined) {
                continue;
            }
            const fontWeight = resolveReference(value.fontWeight, copy);
            // cast because fontStyle is a prop we will add ourselves
            const tokenValue = value;
            if (fontWeight) {
                const fontStyleMatch = fontWeight.match(fontWeightReg);
                if (fontStyleMatch?.groups?.weight && fontStyleMatch.groups.style) {
                    tokenValue.fontStyle = fontStyleMatch.groups.style.toLowerCase();
                    tokenValue.fontWeight = fontStyleMatch?.groups?.weight;
                }
                // Roboto Regular Italic might have only: `fontWeight: 'Italic'`
                // which means that the weight is Regular and the style is Italic
                if (fontStyles.includes(fontWeight.toLowerCase())) {
                    tokenValue.fontStyle = fontWeight.toLowerCase();
                    tokenValue.fontWeight = 'Regular';
                }
            }
            if (!tokenValue.fontStyle && alwaysAddFontStyle) {
                tokenValue.fontStyle = 'normal';
            }
        }
        else if (typeof token === 'object') {
            recurse(token, copy, alwaysAddFontStyle);
        }
    }
}
function addFontStyles(dictionary, transformOpts) {
    const copy = structuredClone(dictionary);
    recurse(copy, copy, transformOpts?.alwaysAddFontStyle);
    return copy;
}

export { addFontStyles };
